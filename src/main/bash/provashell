# PROVASHELL FUNCTIONS - Shell unit testing for the masses

#  Copyright 2014 Daniel Giribet <dani - calidos.cat>
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# CONSTANTS
ERR_=1

#Â locate test functions library
[ -z "$PROVASHELL_LIB" ] && PROVASHELL_LIB=${install.folder_}/provashell.fun



# sanity checks of lib
if [ ! -s "$PROVASHELL_LIB" ]; then
	echo "Can't find the provashell functions library at '$PROVASHELL_LIB'" 1>&2
	echo "Please set the PROVASHELL_LIB env var to point to the provashell.fun file" 1>&2
	exit $ERR_ 
fi

. "$PROVASHELL_LIB"


script_="$0"

# before script setup
start_=$(findAnnotatedFunctions_ "$script_" '@BeforeScript')
[ -n "$start_" ] && $start_

# establish setup and teardown functions if declared

before_=$(findAnnotatedFunctions_ "$script_" '@Before')
after_=$(findAnnotatedFunctions_ "$script_" '@After')

# run the tests themselves, yay!
findAnnotatedFunctions_ "$script_" '@Test' | \
while read t; do
	[ -n "$before_" ] && $before_
		$t
	[ -n "$after_" ] && $after_
done


# after script setup
 end_=$(findAnnotatedFunctions_ "$script_" '@AfterScript')
[ -n "$end_" ] && $end_
